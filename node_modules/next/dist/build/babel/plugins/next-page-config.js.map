{"version":3,"sources":["../../../../build/babel/plugins/next-page-config.ts"],"names":["CONFIG_KEY","replaceBundle","path","t","parentPath","replaceWith","program","variableDeclaration","variableDeclarator","identifier","STRING_LITERAL_DROP_BUNDLE","stringLiteral","Date","now","errorMessage","state","details","pageName","filename","split","cwd","pop","nextPageConfig","types","visitor","Program","enter","traverse","ExportDeclaration","exportPath","exportState","BabelTypes","isExportNamedDeclaration","node","specifiers","some","specifier","exported","name","isStringLiteral","source","Error","ExportNamedDeclaration","bundleDropped","declaration","length","config","declarations","scope","getBinding","filter","Boolean","isIdentifier","local","isImportSpecifier","id","isObjectExpression","init","got","type","prop","properties","isSpreadElement","key","isObjectProperty","isBooleanLiteral","value","amp","file","opts","caller","isDev"],"mappings":"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","sourcesContent":["import { NodePath, PluginObj, types as BabelTypes } from '@babel/core'\nimport { PageConfig } from 'next/types'\nimport { STRING_LITERAL_DROP_BUNDLE } from '../../../next-server/lib/constants'\n\nconst CONFIG_KEY = 'config'\n\n// replace program path with just a variable with the drop identifier\nfunction replaceBundle(path: any, t: typeof BabelTypes): void {\n  path.parentPath.replaceWith(\n    t.program(\n      [\n        t.variableDeclaration('const', [\n          t.variableDeclarator(\n            t.identifier(STRING_LITERAL_DROP_BUNDLE),\n            t.stringLiteral(`${STRING_LITERAL_DROP_BUNDLE} ${Date.now()}`)\n          ),\n        ]),\n      ],\n      []\n    )\n  )\n}\n\nfunction errorMessage(state: any, details: string): string {\n  const pageName =\n    (state.filename || '').split(state.cwd || '').pop() || 'unknown'\n  return `Invalid page config export found. ${details} in file ${pageName}. See: https://err.sh/vercel/next.js/invalid-page-config`\n}\n\ninterface ConfigState {\n  bundleDropped?: boolean\n}\n\n// config to parsing pageConfig for client bundles\nexport default function nextPageConfig({\n  types: t,\n}: {\n  types: typeof BabelTypes\n}): PluginObj {\n  return {\n    visitor: {\n      Program: {\n        enter(path, state: ConfigState) {\n          path.traverse(\n            {\n              ExportDeclaration(exportPath, exportState) {\n                if (\n                  BabelTypes.isExportNamedDeclaration(exportPath) &&\n                  (exportPath.node as BabelTypes.ExportNamedDeclaration).specifiers?.some(\n                    (specifier) => {\n                      return specifier.exported.name === CONFIG_KEY\n                    }\n                  ) &&\n                  BabelTypes.isStringLiteral(\n                    (exportPath.node as BabelTypes.ExportNamedDeclaration)\n                      .source\n                  )\n                ) {\n                  throw new Error(\n                    errorMessage(\n                      exportState,\n                      'Expected object but got export from'\n                    )\n                  )\n                }\n              },\n              ExportNamedDeclaration(\n                exportPath: NodePath<BabelTypes.ExportNamedDeclaration>,\n                exportState: any\n              ) {\n                if (\n                  exportState.bundleDropped ||\n                  (!exportPath.node.declaration &&\n                    exportPath.node.specifiers.length === 0)\n                ) {\n                  return\n                }\n\n                const config: PageConfig = {}\n                const declarations = [\n                  ...(exportPath.node.declaration?.declarations || []),\n                  exportPath.scope.getBinding(CONFIG_KEY)?.path.node,\n                ].filter(Boolean)\n\n                for (const specifier of exportPath.node.specifiers) {\n                  if (specifier.exported.name === CONFIG_KEY) {\n                    // export {} from 'somewhere'\n                    if (BabelTypes.isStringLiteral(exportPath.node.source)) {\n                      throw new Error(\n                        errorMessage(\n                          exportState,\n                          `Expected object but got import`\n                        )\n                      )\n                      // import hello from 'world'\n                      // export { hello as config }\n                    } else if (\n                      BabelTypes.isIdentifier(\n                        (specifier as BabelTypes.ExportSpecifier).local\n                      )\n                    ) {\n                      if (\n                        BabelTypes.isImportSpecifier(\n                          exportPath.scope.getBinding(\n                            (specifier as BabelTypes.ExportSpecifier).local.name\n                          )?.path.node\n                        )\n                      ) {\n                        throw new Error(\n                          errorMessage(\n                            exportState,\n                            `Expected object but got import`\n                          )\n                        )\n                      }\n                    }\n                  }\n                }\n\n                for (const declaration of declarations) {\n                  if (\n                    !BabelTypes.isIdentifier(declaration.id, {\n                      name: CONFIG_KEY,\n                    })\n                  ) {\n                    continue\n                  }\n\n                  if (!BabelTypes.isObjectExpression(declaration.init)) {\n                    const got = declaration.init\n                      ? declaration.init.type\n                      : 'undefined'\n                    throw new Error(\n                      errorMessage(\n                        exportState,\n                        `Expected object but got ${got}`\n                      )\n                    )\n                  }\n\n                  for (const prop of declaration.init.properties) {\n                    if (BabelTypes.isSpreadElement(prop)) {\n                      throw new Error(\n                        errorMessage(\n                          exportState,\n                          `Property spread is not allowed`\n                        )\n                      )\n                    }\n                    const { name } = prop.key\n                    if (BabelTypes.isIdentifier(prop.key, { name: 'amp' })) {\n                      if (!BabelTypes.isObjectProperty(prop)) {\n                        throw new Error(\n                          errorMessage(\n                            exportState,\n                            `Invalid property \"${name}\"`\n                          )\n                        )\n                      }\n                      if (\n                        !BabelTypes.isBooleanLiteral(prop.value) &&\n                        !BabelTypes.isStringLiteral(prop.value)\n                      ) {\n                        throw new Error(\n                          errorMessage(\n                            exportState,\n                            `Invalid value for \"${name}\"`\n                          )\n                        )\n                      }\n                      config.amp = prop.value.value as PageConfig['amp']\n                    }\n                  }\n                }\n\n                if (config.amp === true) {\n                  if (!exportState.file?.opts?.caller.isDev) {\n                    // don't replace bundle in development so HMR can track\n                    // dependencies and trigger reload when they are changed\n                    replaceBundle(exportPath, t)\n                  }\n                  exportState.bundleDropped = true\n                  return\n                }\n              },\n            },\n            state\n          )\n        },\n      },\n    },\n  }\n}\n"]}
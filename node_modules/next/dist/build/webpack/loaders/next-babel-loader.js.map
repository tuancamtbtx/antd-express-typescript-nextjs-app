{"version":3,"sources":["../../../../build/webpack/loaders/next-babel-loader.js"],"names":["cacheKey","nextBabelPreset","require","module","exports","babelLoader","custom","babel","presetItem","createConfigItem","type","applyCommonJs","commonJsItem","configs","Set","customOptions","opts","isServer","pagesDir","babelPresetPlugins","development","hasReactRefresh","hasJsxRuntime","filename","cwd","loader","Object","assign","cache","cacheCompression","cacheDirectory","distDir","cacheIdentifier","JSON","stringify","loadPartialConfig","sourceFileName","options","config","cfg","source","resourcePath","isPageFile","startsWith","hasFilesystemConfig","file","babelrc","has","add","Log","info","presets","caller","isDev","emitWarning","bind","defineProperty","enumerable","writable","value","onWarning","reason","Error","plugins","reactRefreshPlugin","skipEnvCheck","unshift","noAnonymousDefaultExportPlugin","pageConfigPlugin","push","diallowExportAll","indexOf","nextDataPlugin","key","resolve","overrides","test","plugin","dir"],"mappings":"aAAA,oFACA,kFACA,0BACA,6D,w4BAEA;AACA;AACA,KAAMA,CAAAA,QAAQ,CAAG,eAAiB,GAAjB,CAAuB,GAAxC,CACA,KAAMC,CAAAA,eAAe,CAAGC,OAAO,CAAC,oBAAD,CAA/B,CAEAC,MAAM,CAACC,OAAP,CAAiBC,qBAAYC,MAAZ,CAAoBC,KAAD,EAAW,CAC7C,KAAMC,CAAAA,UAAU,CAAGD,KAAK,CAACE,gBAAN,CAAuBR,eAAvB,CAAwC,CACzDS,IAAI,CAAE,QADmD,CAAxC,CAAnB,CAGA,KAAMC,CAAAA,aAAa,CAAGJ,KAAK,CAACE,gBAAN,CACpBP,OAAO,CAAC,8BAAD,CADa,CAEpB,CAAEQ,IAAI,CAAE,QAAR,CAFoB,CAAtB,CAIA,KAAME,CAAAA,YAAY,CAAGL,KAAK,CAACE,gBAAN,CACnBP,OAAO,CAAC,4DAAD,CADY,CAEnB,CAAEQ,IAAI,CAAE,QAAR,CAFmB,CAArB,CAKA,KAAMG,CAAAA,OAAO,CAAG,GAAIC,CAAAA,GAAJ,EAAhB,CAEA,MAAO,CACLC,aAAa,CAACC,IAAD,CAAO,CAClB,KAAMV,CAAAA,MAAM,CAAG,CACbW,QAAQ,CAAED,IAAI,CAACC,QADF,CAEbC,QAAQ,CAAEF,IAAI,CAACE,QAFF,CAGbC,kBAAkB,CAAEH,IAAI,CAACG,kBAHZ,CAIbC,WAAW,CAAEJ,IAAI,CAACI,WAJL,CAKbC,eAAe,CAAEL,IAAI,CAACK,eALT,CAMbC,aAAa,CAAEN,IAAI,CAACM,aANP,CAAf,CAQA,KAAMC,CAAAA,QAAQ,CAAG,eAAKP,IAAI,CAACQ,GAAV,CAAe,SAAf,CAAjB,CACA,KAAMC,CAAAA,MAAM,CAAGC,MAAM,CAACC,MAAP,CACbX,IAAI,CAACY,KAAL,CACI,CACEC,gBAAgB,CAAE,KADpB,CAEEC,cAAc,CAAE,eAAKd,IAAI,CAACe,OAAV,CAAmB,OAAnB,CAA4B,mBAA5B,CAFlB,CAGEC,eAAe,CACbhC,QAAQ,EACPgB,IAAI,CAACC,QAAL,CAAgB,SAAhB,CAA4B,EADrB,CAAR,CAEA,gBAFA,EAGCD,IAAI,CAACI,WAAL,CAAmB,cAAnB,CAAoC,aAHrC,GAICJ,IAAI,CAACK,eAAL,CAAuB,gBAAvB,CAA0C,EAJ3C,GAKCL,IAAI,CAACM,aAAL,CAAqB,cAArB,CAAsC,EALvC,EAMAW,IAAI,CAACC,SAAL,CACE3B,KAAK,CAAC4B,iBAAN,CAAwB,CACtBZ,QADsB,CAEtBC,GAAG,CAAER,IAAI,CAACQ,GAFY,CAGtBY,cAAc,CAAEb,QAHM,CAAxB,EAIGc,OALL,CAVJ,CADJ,CAmBI,CACEP,cAAc,CAAE,KADlB,CApBS,CAuBbd,IAvBa,CAAf,CA0BA,MAAOS,CAAAA,MAAM,CAACR,QAAd,CACA,MAAOQ,CAAAA,MAAM,CAACG,KAAd,CACA,MAAOH,CAAAA,MAAM,CAACM,OAAd,CACA,MAAON,CAAAA,MAAM,CAACP,QAAd,CACA,MAAOO,CAAAA,MAAM,CAACN,kBAAd,CACA,MAAOM,CAAAA,MAAM,CAACL,WAAd,CACA,MAAOK,CAAAA,MAAM,CAACJ,eAAd,CACA,MAAOI,CAAAA,MAAM,CAACH,aAAd,CACA,MAAO,CAAEG,MAAF,CAAUnB,MAAV,CAAP,CACD,CA9CI,CA+CLgC,MAAM,CACJC,GADI,CAEJ,CACEC,MADF,CAEEzB,aAAa,CAAE,CACbE,QADa,CAEbC,QAFa,CAGbC,kBAHa,CAIbC,WAJa,CAKbC,eALa,CAMbC,aANa,CAFjB,CAFI,CAaJ,CACA,KAAMC,CAAAA,QAAQ,CAAG,KAAKkB,YAAtB,CACA,KAAMJ,CAAAA,OAAO,CAAGX,MAAM,CAACC,MAAP,CAAc,EAAd,CAAkBY,GAAG,CAACF,OAAtB,CAAhB,CACA,KAAMK,CAAAA,UAAU,CAAGnB,QAAQ,CAACoB,UAAT,CAAoBzB,QAApB,CAAnB,CAEA,GAAIqB,GAAG,CAACK,mBAAJ,EAAJ,CAA+B,CAC7B,IAAK,KAAMC,CAAAA,IAAX,GAAmB,CAACN,GAAG,CAACO,OAAL,CAAcP,GAAG,CAACD,MAAlB,CAAnB,CAA8C,CAC5C;AACA,GAAIO,IAAI,EAAI,CAAC5B,QAAT,EAAqB,CAACJ,OAAO,CAACkC,GAAR,CAAYF,IAAZ,CAA1B,CAA6C,CAC3ChC,OAAO,CAACmC,GAAR,CAAYH,IAAZ,EACAI,GAAG,CAACC,IAAJ,CAAU,2CAA0CL,IAAK,EAAzD,EACD,CACF,CACF,CARD,IAQO,CACL;AACAR,OAAO,CAACc,OAAR,CAAkB,CAAC,GAAGd,OAAO,CAACc,OAAZ,CAAqB3C,UAArB,CAAlB,CACD,CAED6B,OAAO,CAACe,MAAR,CAAenC,QAAf,CAA0BA,QAA1B,CACAoB,OAAO,CAACe,MAAR,CAAeC,KAAf,CAAuBjC,WAAvB,CACAiB,OAAO,CAACe,MAAR,CAAe9B,aAAf,CAA+BA,aAA/B,CAEA,KAAMgC,CAAAA,WAAW,CAAG,KAAKA,WAAL,CAAiBC,IAAjB,CAAsB,IAAtB,CAApB,CACA7B,MAAM,CAAC8B,cAAP,CAAsBnB,OAAO,CAACe,MAA9B,CAAsC,WAAtC,CAAmD,CACjDK,UAAU,CAAE,KADqC,CAEjDC,QAAQ,CAAE,KAFuC,CAGjDC,KAAK,CAAGtB,OAAO,CAACe,MAAR,CAAeQ,SAAf,CAA2B,SAAUC,MAAV,CAAkB,CACnD,GAAI,EAAEA,MAAM,WAAYC,CAAAA,KAApB,CAAJ,CAAgC,CAC9BD,MAAM,CAAG,GAAIC,CAAAA,KAAJ,CAAUD,MAAV,CAAT,CACD,CACDP,WAAW,CAACO,MAAD,CAAX,CACD,CARgD,CAAnD,EAWAxB,OAAO,CAAC0B,OAAR,CAAkB1B,OAAO,CAAC0B,OAAR,EAAmB,EAArC,CAEA,GAAI1C,eAAJ,CAAqB,CACnB,KAAM2C,CAAAA,kBAAkB,CAAGzD,KAAK,CAACE,gBAAN,CACzB,CAACP,OAAO,CAAC,qBAAD,CAAR,CAAiC,CAAE+D,YAAY,CAAE,IAAhB,CAAjC,CADyB,CAEzB,CAAEvD,IAAI,CAAE,QAAR,CAFyB,CAA3B,CAIA2B,OAAO,CAAC0B,OAAR,CAAgBG,OAAhB,CAAwBF,kBAAxB,EACA,GAAI,CAAC/C,QAAL,CAAe,CACb,KAAMkD,CAAAA,8BAA8B,CAAG5D,KAAK,CAACE,gBAAN,CACrC,CAACP,OAAO,CAAC,iDAAD,CAAR,CAA6D,EAA7D,CADqC,CAErC,CAAEQ,IAAI,CAAE,QAAR,CAFqC,CAAvC,CAIA2B,OAAO,CAAC0B,OAAR,CAAgBG,OAAhB,CAAwBC,8BAAxB,EACD,CACF,CAED,GAAI,CAAClD,QAAD,EAAayB,UAAjB,CAA6B,CAC3B,KAAM0B,CAAAA,gBAAgB,CAAG7D,KAAK,CAACE,gBAAN,CACvB,CAACP,OAAO,CAAC,sCAAD,CAAR,CADuB,CAEvB,CAAEQ,IAAI,CAAE,QAAR,CAFuB,CAAzB,CAIA2B,OAAO,CAAC0B,OAAR,CAAgBM,IAAhB,CAAqBD,gBAArB,EAEA,KAAME,CAAAA,gBAAgB,CAAG/D,KAAK,CAACE,gBAAN,CACvB,CACEP,OAAO,CAAC,8DAAD,CADT,CADuB,CAIvB,CAAEQ,IAAI,CAAE,QAAR,CAJuB,CAAzB,CAMA2B,OAAO,CAAC0B,OAAR,CAAgBM,IAAhB,CAAqBC,gBAArB,EACD,CAED,GAAIrD,QAAQ,EAAIuB,MAAM,CAAC+B,OAAP,CAAe,WAAf,IAAgC,CAAC,CAAjD,CAAoD,CAClD,KAAMC,CAAAA,cAAc,CAAGjE,KAAK,CAACE,gBAAN,CACrB,CACEP,OAAO,CAAC,+BAAD,CADT,CAEE,CAAEuE,GAAG,CAAE,mBAASlD,QAAT,EAAqB,GAArB,CAA2B,wBAAKA,QAAL,CAAlC,CAFF,CADqB,CAKrB,CAAEb,IAAI,CAAE,QAAR,CALqB,CAAvB,CAOA2B,OAAO,CAAC0B,OAAR,CAAgBM,IAAhB,CAAqBG,cAArB,EACD,CAED;AACA;AACA,GAAIhC,MAAM,CAAC+B,OAAP,CAAe,gBAAf,IAAqC,CAAC,CAA1C,CAA6C,CAC3ClC,OAAO,CAAC0B,OAAR,CAAgBM,IAAhB,CAAqB1D,aAArB,EACD,CAED0B,OAAO,CAAC0B,OAAR,CAAgBM,IAAhB,CAAqB,CACnBnE,OAAO,CAACwE,OAAR,CAAgB,+BAAhB,CADmB,CAEnB,CACE,uBAAwBtD,WAAW,CAAG,aAAH,CAAmB,YADxD,CAEE,gBAAiBH,QAAQ,CAAG,WAAH,CAAiB,QAF5C,CAGE,kBAAmBA,QAAQ,CAAG,KAAH,CAAW,IAHxC,CAFmB,CAOnB,mCAPmB,CAArB,EAUA,GAAIyB,UAAJ,CAAgB,CACd,GAAI,CAACzB,QAAL,CAAe,CACboB,OAAO,CAAC0B,OAAR,CAAgBM,IAAhB,CAAqB,CACnBnE,OAAO,CAACwE,OAAR,CAAgB,wCAAhB,CADmB,CAEnB,EAFmB,CAArB,EAID,CACF,CAED;AACArC,OAAO,CAACsC,SAAR,CAAoB,CAClB,IAAItC,OAAO,CAACsC,SAAR,EAAqB,EAAzB,CADkB,CAElB,CACEC,IAAI,CAAE,CACJ,uCADI,CAEJ,0BAFI,CAGJ,yBAHI,CADR,CAMEb,OAAO,CAAE,CAACnD,YAAD,CANX,CAFkB,CAApB,CAYA,IAAK,KAAMiE,CAAAA,MAAX,GAAqB1D,CAAAA,kBAArB,CAAyC,CACvCjB,OAAO,CAAC,eAAK2E,MAAM,CAACC,GAAZ,CAAiB,KAAjB,CAAwB,uBAAxB,CAAD,CAAP,CACEzC,OADF,CAEEwC,MAAM,CAACvC,MAAP,EAAiB,EAFnB,EAID,CAED,MAAOD,CAAAA,OAAP,CACD,CAxLI,CAAP,CA0LD,CAzMgB,CAAjB","sourcesContent":["import babelLoader from 'next/dist/compiled/babel-loader'\nimport hash from 'next/dist/compiled/string-hash'\nimport { basename, join } from 'path'\nimport * as Log from '../../output/log'\n\n// increment 'n' to invalidate cache\n// eslint-disable-next-line no-useless-concat\nconst cacheKey = 'babel-cache-' + 'n' + '-'\nconst nextBabelPreset = require('../../babel/preset')\n\nmodule.exports = babelLoader.custom((babel) => {\n  const presetItem = babel.createConfigItem(nextBabelPreset, {\n    type: 'preset',\n  })\n  const applyCommonJs = babel.createConfigItem(\n    require('../../babel/plugins/commonjs'),\n    { type: 'plugin' }\n  )\n  const commonJsItem = babel.createConfigItem(\n    require('next/dist/compiled/babel/plugin-transform-modules-commonjs'),\n    { type: 'plugin' }\n  )\n\n  const configs = new Set()\n\n  return {\n    customOptions(opts) {\n      const custom = {\n        isServer: opts.isServer,\n        pagesDir: opts.pagesDir,\n        babelPresetPlugins: opts.babelPresetPlugins,\n        development: opts.development,\n        hasReactRefresh: opts.hasReactRefresh,\n        hasJsxRuntime: opts.hasJsxRuntime,\n      }\n      const filename = join(opts.cwd, 'noop.js')\n      const loader = Object.assign(\n        opts.cache\n          ? {\n              cacheCompression: false,\n              cacheDirectory: join(opts.distDir, 'cache', 'next-babel-loader'),\n              cacheIdentifier:\n                cacheKey +\n                (opts.isServer ? '-server' : '') +\n                '-new-polyfills' +\n                (opts.development ? '-development' : '-production') +\n                (opts.hasReactRefresh ? '-react-refresh' : '') +\n                (opts.hasJsxRuntime ? '-jsx-runtime' : '') +\n                JSON.stringify(\n                  babel.loadPartialConfig({\n                    filename,\n                    cwd: opts.cwd,\n                    sourceFileName: filename,\n                  }).options\n                ),\n            }\n          : {\n              cacheDirectory: false,\n            },\n        opts\n      )\n\n      delete loader.isServer\n      delete loader.cache\n      delete loader.distDir\n      delete loader.pagesDir\n      delete loader.babelPresetPlugins\n      delete loader.development\n      delete loader.hasReactRefresh\n      delete loader.hasJsxRuntime\n      return { loader, custom }\n    },\n    config(\n      cfg,\n      {\n        source,\n        customOptions: {\n          isServer,\n          pagesDir,\n          babelPresetPlugins,\n          development,\n          hasReactRefresh,\n          hasJsxRuntime,\n        },\n      }\n    ) {\n      const filename = this.resourcePath\n      const options = Object.assign({}, cfg.options)\n      const isPageFile = filename.startsWith(pagesDir)\n\n      if (cfg.hasFilesystemConfig()) {\n        for (const file of [cfg.babelrc, cfg.config]) {\n          // We only log for client compilation otherwise there will be double output\n          if (file && !isServer && !configs.has(file)) {\n            configs.add(file)\n            Log.info(`Using external babel configuration from ${file}`)\n          }\n        }\n      } else {\n        // Add our default preset if the no \"babelrc\" found.\n        options.presets = [...options.presets, presetItem]\n      }\n\n      options.caller.isServer = isServer\n      options.caller.isDev = development\n      options.caller.hasJsxRuntime = hasJsxRuntime\n\n      const emitWarning = this.emitWarning.bind(this)\n      Object.defineProperty(options.caller, 'onWarning', {\n        enumerable: false,\n        writable: false,\n        value: (options.caller.onWarning = function (reason) {\n          if (!(reason instanceof Error)) {\n            reason = new Error(reason)\n          }\n          emitWarning(reason)\n        }),\n      })\n\n      options.plugins = options.plugins || []\n\n      if (hasReactRefresh) {\n        const reactRefreshPlugin = babel.createConfigItem(\n          [require('react-refresh/babel'), { skipEnvCheck: true }],\n          { type: 'plugin' }\n        )\n        options.plugins.unshift(reactRefreshPlugin)\n        if (!isServer) {\n          const noAnonymousDefaultExportPlugin = babel.createConfigItem(\n            [require('../../babel/plugins/no-anonymous-default-export'), {}],\n            { type: 'plugin' }\n          )\n          options.plugins.unshift(noAnonymousDefaultExportPlugin)\n        }\n      }\n\n      if (!isServer && isPageFile) {\n        const pageConfigPlugin = babel.createConfigItem(\n          [require('../../babel/plugins/next-page-config')],\n          { type: 'plugin' }\n        )\n        options.plugins.push(pageConfigPlugin)\n\n        const diallowExportAll = babel.createConfigItem(\n          [\n            require('../../babel/plugins/next-page-disallow-re-export-all-exports'),\n          ],\n          { type: 'plugin' }\n        )\n        options.plugins.push(diallowExportAll)\n      }\n\n      if (isServer && source.indexOf('next/data') !== -1) {\n        const nextDataPlugin = babel.createConfigItem(\n          [\n            require('../../babel/plugins/next-data'),\n            { key: basename(filename) + '-' + hash(filename) },\n          ],\n          { type: 'plugin' }\n        )\n        options.plugins.push(nextDataPlugin)\n      }\n\n      // If the file has `module.exports` we have to transpile commonjs because Babel adds `import` statements\n      // That break webpack, since webpack doesn't support combining commonjs and esmodules\n      if (source.indexOf('module.exports') !== -1) {\n        options.plugins.push(applyCommonJs)\n      }\n\n      options.plugins.push([\n        require.resolve('babel-plugin-transform-define'),\n        {\n          'process.env.NODE_ENV': development ? 'development' : 'production',\n          'typeof window': isServer ? 'undefined' : 'object',\n          'process.browser': isServer ? false : true,\n        },\n        'next-js-transform-define-instance',\n      ])\n\n      if (isPageFile) {\n        if (!isServer) {\n          options.plugins.push([\n            require.resolve('../../babel/plugins/next-ssg-transform'),\n            {},\n          ])\n        }\n      }\n\n      // As next-server/lib has stateful modules we have to transpile commonjs\n      options.overrides = [\n        ...(options.overrides || []),\n        {\n          test: [\n            /next[\\\\/]dist[\\\\/]next-server[\\\\/]lib/,\n            /next[\\\\/]dist[\\\\/]client/,\n            /next[\\\\/]dist[\\\\/]pages/,\n          ],\n          plugins: [commonJsItem],\n        },\n      ]\n\n      for (const plugin of babelPresetPlugins) {\n        require(join(plugin.dir, 'src', 'babel-preset-build.js'))(\n          options,\n          plugin.config || {}\n        )\n      }\n\n      return options\n    },\n  }\n})\n"]}
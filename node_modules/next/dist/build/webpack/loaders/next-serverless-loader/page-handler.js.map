{"version":3,"sources":["../../../../../build/webpack/loaders/next-serverless-loader/page-handler.ts"],"names":["getPageHandler","ctx","page","pageComponent","pageConfig","pageGetStaticProps","pageGetStaticPaths","pageGetServerSideProps","appModule","documentModule","errorModule","notFoundModule","encodedPreviewProps","pageIsDynamic","generateEtags","poweredByHeader","runtimeConfig","buildManifest","reactLoadableManifest","i18n","buildId","basePath","assetPrefix","canonicalBase","escapedBuildId","experimental","initServer","onError","handleLocale","handleRewrites","handleBasePath","defaultRouteRegex","dynamicRouteMatcher","interpolateDynamicPath","getParamsFromRouteMatches","normalizeDynamicRouteParams","normalizeVercelUrl","renderReqToHTML","req","res","renderMode","_renderOpts","_params","Component","App","config","Document","Error","notFoundMod","getStaticProps","getStaticPaths","getServerSideProps","default","Promise","all","fromExport","nextStartMode","hasValidParams","options","publicRuntimeConfig","previewProps","env","process","_nextData","defaultLocale","detectedLocale","parsedUrl","trustQuery","headers","vercelHeader","url","routeNoAssetPath","pathname","replace","RegExp","origQuery","Object","assign","query","amp","queryNoAmp","search","undefined","match","localeResult","nextInternalLocale","renderOpts","nextExport","isDataReq","locales","locale","statusCode","params","result","nowParams","_parsedUrl","param","keys","groups","resolvedUrl","resolvedAsPath","isFallback","__nextFallback","previewData","isPreviewMode","__NEXT_OPTIMIZE_FONTS","optimizeFonts","fontManifest","__webpack_require__","__NEXT_FONT_MANIFEST__","isNotFound","NotFoundComponent","errPathname","result2","err","private","stateful","revalidate","isRedirect","redirect","destination","pageData","pageProps","__N_REDIRECT","__N_REDIRECT_STATUS","__N_REDIRECT_BASE_PATH","PERMANENT_REDIRECT_STATUS","setHeader","end","JSON","stringify","html","code","console","error","underErrorErr","render"],"mappings":"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","sourcesContent":["import { IncomingMessage, ServerResponse } from 'http'\nimport { parse as parseUrl, format as formatUrl, UrlWithParsedQuery } from 'url'\nimport { isResSent } from '../../../../next-server/lib/utils'\nimport { sendPayload } from '../../../../next-server/server/send-payload'\nimport { getUtils, vercelHeader, ServerlessHandlerCtx } from './utils'\n\nimport { renderToHTML } from '../../../../next-server/server/render'\nimport { tryGetPreviewData } from '../../../../next-server/server/api-utils'\nimport { denormalizePagePath } from '../../../../next-server/server/denormalize-page-path'\nimport {\n  setLazyProp,\n  getCookieParser,\n} from '../../../../next-server/server/api-utils'\nimport { getRedirectStatus } from '../../../../lib/load-custom-routes'\nimport getRouteNoAssetPath from '../../../../next-server/lib/router/utils/get-route-from-asset-path'\nimport { PERMANENT_REDIRECT_STATUS } from '../../../../next-server/lib/constants'\n\nexport function getPageHandler(ctx: ServerlessHandlerCtx) {\n  const {\n    page,\n\n    pageComponent,\n    pageConfig,\n    pageGetStaticProps,\n    pageGetStaticPaths,\n    pageGetServerSideProps,\n\n    appModule,\n    documentModule,\n    errorModule,\n    notFoundModule,\n\n    encodedPreviewProps,\n    pageIsDynamic,\n    generateEtags,\n    poweredByHeader,\n\n    runtimeConfig,\n    buildManifest,\n    reactLoadableManifest,\n\n    i18n,\n    buildId,\n    basePath,\n    assetPrefix,\n    canonicalBase,\n    escapedBuildId,\n\n    experimental: { initServer, onError },\n  } = ctx\n  const {\n    handleLocale,\n    handleRewrites,\n    handleBasePath,\n    defaultRouteRegex,\n    dynamicRouteMatcher,\n    interpolateDynamicPath,\n    getParamsFromRouteMatches,\n    normalizeDynamicRouteParams,\n    normalizeVercelUrl,\n  } = getUtils(ctx)\n\n  async function renderReqToHTML(\n    req: IncomingMessage,\n    res: ServerResponse,\n    renderMode?: 'export' | 'passthrough' | true,\n    _renderOpts?: any,\n    _params?: any\n  ) {\n    let Component\n    let App\n    let config\n    let Document\n    let Error\n    let notFoundMod\n    let getStaticProps\n    let getStaticPaths\n    let getServerSideProps\n    ;[\n      getStaticProps,\n      getServerSideProps,\n      getStaticPaths,\n      Component,\n      App,\n      config,\n      { default: Document },\n      { default: Error },\n      notFoundMod,\n    ] = await Promise.all([\n      pageGetStaticProps,\n      pageGetServerSideProps,\n      pageGetStaticPaths,\n      pageComponent,\n      appModule,\n      pageConfig,\n      documentModule,\n      errorModule,\n      notFoundModule,\n    ])\n\n    const fromExport = renderMode === 'export' || renderMode === true\n    const nextStartMode = renderMode === 'passthrough'\n\n    let hasValidParams = true\n\n    setLazyProp({ req: req as any }, 'cookies', getCookieParser(req))\n\n    const options = {\n      App,\n      Document,\n      buildManifest,\n      getStaticProps,\n      getServerSideProps,\n      getStaticPaths,\n      reactLoadableManifest,\n      canonicalBase,\n      buildId,\n      assetPrefix,\n      runtimeConfig: (runtimeConfig || {}).publicRuntimeConfig || {},\n      previewProps: encodedPreviewProps,\n      env: process.env,\n      basePath,\n      ..._renderOpts,\n    }\n    let _nextData = false\n    let defaultLocale = i18n?.defaultLocale\n    let detectedLocale = i18n?.defaultLocale\n    let parsedUrl: UrlWithParsedQuery\n\n    try {\n      // We need to trust the dynamic route params from the proxy\n      // to ensure we are using the correct values\n      const trustQuery = !getStaticProps && req.headers[vercelHeader]\n      parsedUrl = parseUrl(req.url!, true)\n      let routeNoAssetPath = parsedUrl.pathname!\n\n      if (basePath) {\n        routeNoAssetPath =\n          routeNoAssetPath.replace(new RegExp(`^${basePath}`), '') || '/'\n      }\n      const origQuery = Object.assign({}, parsedUrl.query)\n\n      parsedUrl = handleRewrites(parsedUrl)\n      handleBasePath(req, parsedUrl)\n\n      // remove ?amp=1 from request URL if rendering for export\n      if (fromExport && parsedUrl.query.amp) {\n        const queryNoAmp = Object.assign({}, origQuery)\n        delete queryNoAmp.amp\n\n        req.url = formatUrl({\n          ...parsedUrl,\n          search: undefined,\n          query: queryNoAmp,\n        })\n      }\n\n      if (parsedUrl.pathname!.match(/_next\\/data/)) {\n        _nextData = page !== '/_error'\n        parsedUrl.pathname = getRouteNoAssetPath(\n          parsedUrl.pathname!.replace(\n            new RegExp(`/_next/data/${escapedBuildId}/`),\n            '/'\n          ),\n          '.json'\n        )\n        routeNoAssetPath = parsedUrl.pathname\n      }\n\n      const localeResult = handleLocale(\n        req,\n        res,\n        parsedUrl,\n        routeNoAssetPath,\n        fromExport || nextStartMode\n      )\n      defaultLocale = localeResult?.defaultLocale || defaultLocale\n      detectedLocale = localeResult?.detectedLocale || detectedLocale\n      routeNoAssetPath = localeResult?.routeNoAssetPath || routeNoAssetPath\n\n      if (parsedUrl.query.nextInternalLocale) {\n        detectedLocale = parsedUrl.query.nextInternalLocale as string\n        delete parsedUrl.query.nextInternalLocale\n      }\n\n      const renderOpts = Object.assign(\n        {\n          Component,\n          pageConfig: config,\n          nextExport: fromExport,\n          isDataReq: _nextData,\n          locales: i18n?.locales,\n          locale: detectedLocale,\n          defaultLocale,\n        },\n        options\n      )\n\n      if (page === '/_error' && !res.statusCode) {\n        res.statusCode = 404\n      }\n\n      let params = {}\n\n      if (!fromExport && pageIsDynamic) {\n        const result = normalizeDynamicRouteParams(\n          trustQuery\n            ? parsedUrl.query\n            : (dynamicRouteMatcher!(parsedUrl.pathname) as Record<\n                string,\n                string | string[]\n              >)\n        )\n\n        hasValidParams = result.hasValidParams\n        params = result.params\n      }\n\n      let nowParams = null\n\n      if (\n        pageIsDynamic &&\n        !hasValidParams &&\n        req.headers?.['x-now-route-matches']\n      ) {\n        nowParams = getParamsFromRouteMatches(req, renderOpts, detectedLocale)\n      }\n\n      // make sure to set renderOpts to the correct params e.g. _params\n      // if provided from worker or params if we're parsing them here\n      renderOpts.params = _params || params\n\n      normalizeVercelUrl(req, !!trustQuery)\n\n      // normalize request URL/asPath for fallback/revalidate pages since the\n      // proxy sets the request URL to the output's path for fallback pages\n      if (pageIsDynamic && nowParams && defaultRouteRegex) {\n        const _parsedUrl = parseUrl(req.url!)\n\n        _parsedUrl.pathname = interpolateDynamicPath(\n          _parsedUrl.pathname!,\n          nowParams\n        )\n        parsedUrl.pathname = _parsedUrl.pathname\n        req.url = formatUrl(_parsedUrl)\n      }\n\n      // make sure to normalize asPath for revalidate and _next/data requests\n      // since the asPath should match what is shown on the client\n      if (!fromExport && (getStaticProps || getServerSideProps)) {\n        // don't include dynamic route params in query while normalizing\n        // asPath\n        if (pageIsDynamic && trustQuery && defaultRouteRegex) {\n          delete (parsedUrl as any).search\n\n          for (const param of Object.keys(defaultRouteRegex.groups)) {\n            delete origQuery[param]\n          }\n        }\n\n        parsedUrl.pathname = denormalizePagePath(parsedUrl.pathname!)\n        renderOpts.resolvedUrl = formatUrl({\n          ...parsedUrl,\n          query: origQuery,\n        })\n\n        // For getServerSideProps we need to ensure we use the original URL\n        // and not the resolved URL to prevent a hydration mismatch on asPath\n        renderOpts.resolvedAsPath = getServerSideProps\n          ? formatUrl({\n              ...parsedUrl,\n              pathname: routeNoAssetPath,\n              query: origQuery,\n            })\n          : renderOpts.resolvedUrl\n      }\n\n      const isFallback = parsedUrl.query.__nextFallback\n\n      const previewData = tryGetPreviewData(req, res, options.previewProps)\n      const isPreviewMode = previewData !== false\n\n      if (process.env.__NEXT_OPTIMIZE_FONTS) {\n        renderOpts.optimizeFonts = true\n        /**\n         * __webpack_require__.__NEXT_FONT_MANIFEST__ is added by\n         * font-stylesheet-gathering-plugin\n         */\n        // @ts-ignore\n        renderOpts.fontManifest = __webpack_require__.__NEXT_FONT_MANIFEST__\n      }\n\n      let result = await renderToHTML(\n        req,\n        res,\n        page,\n        Object.assign(\n          {},\n          getStaticProps\n            ? { ...(parsedUrl.query.amp ? { amp: '1' } : {}) }\n            : parsedUrl.query,\n          nowParams ? nowParams : params,\n          _params,\n          isFallback ? { __nextFallback: 'true' } : {}\n        ),\n        renderOpts\n      )\n\n      if (!renderMode) {\n        if (_nextData || getStaticProps || getServerSideProps) {\n          if (renderOpts.isNotFound) {\n            res.statusCode = 404\n\n            const NotFoundComponent = notFoundMod ? notFoundMod.default : Error\n            const errPathname = notFoundMod ? '/404' : '/_error'\n\n            const result2 = await renderToHTML(\n              req,\n              res,\n              errPathname,\n              parsedUrl.query,\n              Object.assign({}, options, {\n                getStaticProps: notFoundMod\n                  ? notFoundMod.getStaticProps\n                  : undefined,\n                getStaticPaths: undefined,\n                getServerSideProps: undefined,\n                Component: NotFoundComponent,\n                err: undefined,\n                locale: detectedLocale,\n                locales: i18n?.locales,\n                defaultLocale: i18n?.defaultLocale,\n              })\n            )\n\n            sendPayload(\n              req,\n              res,\n              result2,\n              'html',\n              {\n                generateEtags,\n                poweredByHeader,\n              },\n              {\n                private: isPreviewMode,\n                stateful: !!getServerSideProps,\n                revalidate: renderOpts.revalidate,\n              }\n            )\n            return null\n          } else if (renderOpts.isRedirect && !_nextData) {\n            const redirect = {\n              destination: renderOpts.pageData.pageProps.__N_REDIRECT,\n              statusCode: renderOpts.pageData.pageProps.__N_REDIRECT_STATUS,\n              basePath: renderOpts.pageData.pageProps.__N_REDIRECT_BASE_PATH,\n            }\n            const statusCode = getRedirectStatus(redirect)\n\n            if (basePath && redirect.basePath !== false) {\n              redirect.destination = `${basePath}${redirect.destination}`\n            }\n\n            if (statusCode === PERMANENT_REDIRECT_STATUS) {\n              res.setHeader('Refresh', `0;url=${redirect.destination}`)\n            }\n\n            res.statusCode = statusCode\n            res.setHeader('Location', redirect.destination)\n            res.end()\n            return null\n          } else {\n            sendPayload(\n              req,\n              res,\n              _nextData ? JSON.stringify(renderOpts.pageData) : result,\n              _nextData ? 'json' : 'html',\n              {\n                generateEtags,\n                poweredByHeader,\n              },\n              {\n                private: isPreviewMode,\n                stateful: !!getServerSideProps,\n                revalidate: renderOpts.revalidate,\n              }\n            )\n            return null\n          }\n        }\n      } else if (isPreviewMode) {\n        res.setHeader(\n          'Cache-Control',\n          'private, no-cache, no-store, max-age=0, must-revalidate'\n        )\n      }\n\n      if (renderMode) return { html: result, renderOpts }\n      return result\n    } catch (err) {\n      if (!parsedUrl!) {\n        parsedUrl = parseUrl(req.url!, true)\n      }\n\n      if (err.code === 'ENOENT') {\n        res.statusCode = 404\n      } else if (err.code === 'DECODE_FAILED') {\n        // TODO: better error?\n        res.statusCode = 400\n      } else {\n        console.error('Unhandled error during request:', err)\n\n        // Backwards compat (call getInitialProps in custom error):\n        try {\n          await renderToHTML(\n            req,\n            res,\n            '/_error',\n            parsedUrl!.query,\n            Object.assign({}, options, {\n              getStaticProps: undefined,\n              getStaticPaths: undefined,\n              getServerSideProps: undefined,\n              Component: Error,\n              err: err,\n              // Short-circuit rendering:\n              isDataReq: true,\n            })\n          )\n        } catch (underErrorErr) {\n          console.error(\n            'Failed call /_error subroutine, continuing to crash function:',\n            underErrorErr\n          )\n        }\n\n        // Throw the error to crash the serverless function\n        if (isResSent(res)) {\n          console.error('!!! WARNING !!!')\n          console.error(\n            'Your function crashed, but closed the response before allowing the function to exit.\\\\n' +\n              'This may cause unexpected behavior for the next request.'\n          )\n          console.error('!!! WARNING !!!')\n        }\n        throw err\n      }\n\n      const result2 = await renderToHTML(\n        req,\n        res,\n        '/_error',\n        parsedUrl!.query,\n        Object.assign({}, options, {\n          getStaticProps: undefined,\n          getStaticPaths: undefined,\n          getServerSideProps: undefined,\n          Component: Error,\n          err: res.statusCode === 404 ? undefined : err,\n        })\n      )\n      return result2\n    }\n  }\n\n  return {\n    renderReqToHTML,\n    render: async function render(req: IncomingMessage, res: ServerResponse) {\n      try {\n        await initServer()\n        const html = await renderReqToHTML(req, res)\n        if (html) {\n          sendPayload(req, res, html, 'html', {\n            generateEtags,\n            poweredByHeader,\n          })\n        }\n      } catch (err) {\n        console.error(err)\n        await onError(err)\n        // Throw the error to crash the serverless function\n        throw err\n      }\n    },\n  }\n}\n"]}